import { NextRequest, NextResponse } from 'next/server';
import { NeynarAPIClient } from "@neynar/nodejs-sdk";

const APP_URL = process.env.NEXT_PUBLIC_URL || 'https://fcempowertours-production-6551.up.railway.app';
const NEYNAR_API_KEY = process.env.NEXT_PUBLIC_NEYNAR_API_KEY || '';
const BOT_SIGNER_UUID = process.env.BOT_SIGNER_UUID || '';

export async function POST(req: NextRequest) {
  try {
    const {
      type,           // 'passport' | 'music_mint' | 'music_purchase'
      fid,            // Farcaster ID
      tokenId,        // NFT token ID
      txHash,         // Transaction hash
      countryCode,    // For passport
      countryName,    // For passport
      songTitle,      // For music
      price,          // For music
      artist,         // For music purchase
    } = await req.json();

    console.log('üéµ [CAST] Posting cast:', { type, fid, tokenId, countryCode, songTitle });

    if (!fid) {
      console.log('‚ÑπÔ∏è No FID provided, skipping cast');
      return NextResponse.json({ success: true, message: 'No FID provided' });
    }

    if (!BOT_SIGNER_UUID || !NEYNAR_API_KEY) {
      console.error('‚ùå Missing BOT_SIGNER_UUID or NEYNAR_API_KEY');
      return NextResponse.json(
        { success: false, error: 'Server configuration error' },
        { status: 500 }
      );
    }

    const client = new NeynarAPIClient({
      apiKey: NEYNAR_API_KEY,
    });

    let castText = '';
    let embeds: Array<{ url: string }> = [];

    // ==================== PASSPORT CAST ====================
    if (type === 'passport') {
      const castUrl = `${APP_URL}/passport?tokenId=${tokenId}`;
      castText = `üé´ New EmpowerTours Passport Minted!

${countryCode} ${countryName}

Token #${tokenId}

View: https://testnet.monadscan.com/tx/${txHash}

@empowertours`;

      embeds = [{ url: castUrl }];
      console.log('üì¢ Passport cast text:', castText);
    }

    // ==================== MUSIC MINT CAST ====================
    else if (type === 'music_mint') {
      const musicUrl = `${APP_URL}/music?tokenId=${tokenId}`;
      castText = `üéµ New Music Master NFT Minted!

"${songTitle || 'Untitled'}" - Token #${tokenId}
üí∞ License Price: ${price || '1'} TOURS

‚ö° Gasless minting powered by @empowertours
üé∂ Purchase license to stream full track

View: https://testnet.monadscan.com/tx/${txHash}

@empowertours`;

      embeds = [{ url: musicUrl }];
      console.log('üì¢ Music mint cast text:', castText);
    }

    // ==================== MUSIC PURCHASE CAST ====================
    else if (type === 'music_purchase') {
      castText = `üé∂ Just Purchased a Music License on @empowertours!

Now I can stream "${songTitle || 'Untitled'}" üéµ

TX: https://testnet.monadscan.com/tx/${txHash}

Gasless - they paid the gas! üöÄ

@empowertours`;

      console.log('üì¢ Music purchase cast text:', castText);
    }

    if (!castText) {
      return NextResponse.json(
        { success: false, error: `Unknown cast type: ${type}` },
        { status: 400 }
      );
    }

    // ==================== POST TO FARCASTER ====================
    console.log('üì§ Publishing cast with Neynar SDK...');
    const result = await client.publishCast({
      signerUuid: BOT_SIGNER_UUID,
      text: castText,
      embeds: embeds.length > 0 ? embeds : undefined,
    });

    console.log('‚úÖ Cast posted successfully:', {
      hash: result.cast?.hash,
      type,
      tokenId,
    });

    return NextResponse.json({
      success: true,
      castHash: result.cast?.hash,
      type,
      tokenId,
    });

  } catch (error: any) {
    console.error('‚ùå [CAST] Error:', error.message);
    // Don't return error status - casting failures shouldn't block mints
    return NextResponse.json({
      success: false,
      error: error.message,
      message: 'Cast posting failed but mint succeeded'
    }, { status: 200 }); // Return 200 so client doesn't treat it as a failure
  }
}
