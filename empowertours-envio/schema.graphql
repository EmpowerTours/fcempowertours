# ✅ UPDATED: Added MusicLicense entity to track purchased music NFTs

type MusicNFT @entity {
  id: ID!
  tokenId: String!
  contract: String!
  artist: String!
  owner: String!
  tokenURI: String!
  coverArt: String
  price: BigInt                # ← NEW: Track license price
  totalSold: Int               # ← NEW: Track total licenses sold
  active: Boolean              # ← NEW: Track if sales are active
  royaltyPercentage: Int       # ← NEW: Track royalty % (optional)
  mintedAt: Timestamp!
  blockNumber: BigInt!
  txHash: String!
  licenses: [MusicLicense!]! @derivedFrom(field: "masterToken")  # ← NEW: Link to purchases
}

# ✅ NEW: Track purchased music licenses
type MusicLicense @entity {
  id: ID!
  licenseId: String!           # ← Unique license ID
  masterTokenId: String!       # ← Which music NFT was purchased
  masterToken: MusicNFT!       # ← Link back to the music NFT
  licensee: String!            # ← Who bought it
  expiry: BigInt!              # ← When license expires
  active: Boolean!             # ← Is license still valid
  purchasedAt: Timestamp!      # ← When purchased
  blockNumber: BigInt!
  txHash: String!
}

type PassportNFT @entity {
  id: ID!
  tokenId: String!
  contract: String!
  owner: String!
  countryCode: String!         # ← Required now
  countryName: String!         # ← NEW
  region: String!              # ← NEW
  continent: String!           # ← NEW
  tokenURI: String
  mintedAt: Timestamp!
  blockNumber: BigInt!
  txHash: String!
}

type Itinerary @entity {
  id: ID!
  itineraryId: String!
  creator: String!
  description: String
  price: BigInt!
  active: Boolean!
  createdAt: Timestamp!
  blockNumber: BigInt!
  purchases: [ItineraryPurchase!]! @derivedFrom(field: "itinerary")
}

type ItineraryPurchase @entity {
  id: ID!
  itinerary: Itinerary!
  itineraryId: String!
  buyer: String!
  timestamp: Timestamp!
  blockNumber: BigInt!
  txHash: String!
}

type UserStats @entity {
  id: ID!
  address: String!
  musicNFTCount: Int!          # ← Music created by user
  passportNFTCount: Int!
  itinerariesCreated: Int!
  itinerariesPurchased: Int!
  licensesOwned: Int!          # ← NEW: Licenses purchased by user
  totalNFTs: Int!
  lastActive: Timestamp!
}

type GlobalStats @entity {
  id: ID!
  totalMusicNFTs: Int!
  totalPassports: Int!
  totalItineraries: Int!
  totalItineraryPurchases: Int!
  totalMusicLicensesPurchased: Int!  # ← NEW: Total licenses sold
  totalUsers: Int!
  lastUpdated: Timestamp!
}
