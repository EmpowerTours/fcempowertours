<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>EmpowerTours - Arquitectura Tecnica</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  @page { size: A4 portrait; margin: 15mm; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #0f172a; color: #e2e8f0; max-width: 210mm; margin: 0 auto; padding: 20px 30px;
  }
  h1 { font-size: 24px; font-weight: 800; color: #06b6d4; margin-bottom: 4px; }
  h2 { font-size: 16px; font-weight: 700; color: #06b6d4; margin: 18px 0 8px; border-bottom: 1px solid rgba(6,182,212,0.2); padding-bottom: 4px; }
  h3 { font-size: 13px; font-weight: 600; color: #a78bfa; margin: 10px 0 4px; }
  p { font-size: 11px; line-height: 1.5; color: #94a3b8; margin-bottom: 6px; }
  .subtitle { font-size: 12px; color: #64748b; margin-bottom: 16px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  .box {
    background: rgba(30,41,59,0.8); border: 1px solid rgba(51,65,85,0.8);
    border-radius: 8px; padding: 10px 12px; margin-bottom: 8px;
  }
  .mono { font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 9px; color: #06b6d4; background: rgba(6,182,212,0.08); padding: 2px 5px; border-radius: 3px; }
  .code-block {
    font-family: monospace; font-size: 9px; background: #1e293b; border: 1px solid #334155;
    border-radius: 6px; padding: 8px 12px; margin: 6px 0; white-space: pre-wrap; color: #94a3b8; line-height: 1.6;
  }
  .flow-diagram {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    margin: 10px 0; flex-wrap: wrap;
  }
  .flow-box {
    background: rgba(6,182,212,0.08); border: 1px solid rgba(6,182,212,0.2);
    border-radius: 6px; padding: 6px 10px; font-size: 10px; text-align: center; color: #06b6d4;
  }
  .flow-arrow { color: #475569; font-size: 14px; }
  ul { list-style: none; padding: 0; }
  ul li { font-size: 10px; padding: 2px 0 2px 12px; position: relative; color: #94a3b8; }
  ul li::before { content: ''; position: absolute; left: 0; top: 7px; width: 4px; height: 4px; border-radius: 50%; background: #06b6d4; }
  table { width: 100%; border-collapse: collapse; font-size: 9px; margin: 6px 0; }
  th { background: rgba(6,182,212,0.1); color: #06b6d4; text-align: left; padding: 4px 8px; border: 1px solid #334155; }
  td { padding: 4px 8px; border: 1px solid #334155; color: #94a3b8; }
  .tag { display: inline-block; padding: 1px 6px; border-radius: 8px; font-size: 8px; background: rgba(6,182,212,0.1); color: #06b6d4; margin: 1px; }
  .page-break { page-break-before: always; }
  @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
</style>
</head>
<body>

<h1>EmpowerTours - Documento Tecnico</h1>
<p class="subtitle">Arquitectura del Sistema, Contratos Inteligentes y Flujos de Datos</p>

<!-- System Architecture Overview -->
<h2>1. Arquitectura del Sistema</h2>

<div class="flow-diagram">
  <div class="flow-box">Warpcast<br><span style="font-size:8px;">Farcaster Frame</span></div>
  <div class="flow-arrow">&#8594;</div>
  <div class="flow-box">Next.js 15<br><span style="font-size:8px;">App Router + API</span></div>
  <div class="flow-arrow">&#8594;</div>
  <div class="flow-box">Gemini AI<br><span style="font-size:8px;">Intent Parsing</span></div>
  <div class="flow-arrow">&#8594;</div>
  <div class="flow-box">Pimlico<br><span style="font-size:8px;">ERC-4337 Bundler</span></div>
  <div class="flow-arrow">&#8594;</div>
  <div class="flow-box">Monad<br><span style="font-size:8px;">Smart Contracts</span></div>
</div>

<div class="grid-2">
  <div class="box">
    <h3>Frontend Layer</h3>
    <ul>
      <li><strong>Next.js 15</strong> - App Router, Server Components</li>
      <li><strong>Farcaster Frame SDK</strong> - Mini App dentro de Warpcast</li>
      <li><strong>Tailwind CSS</strong> - UI responsive</li>
      <li><strong>TypeScript</strong> - Type safety end-to-end</li>
      <li><strong>Viem</strong> - Blockchain interactions (preferred over ethers.js)</li>
    </ul>
  </div>
  <div class="box">
    <h3>Backend Layer</h3>
    <ul>
      <li><strong>API Routes</strong> - 40+ endpoints en /app/api/</li>
      <li><strong>Google Gemini 2.5 Flash</strong> - AI Oracle con structured output</li>
      <li><strong>Google Maps Grounding</strong> - Places API verificado</li>
      <li><strong>Redis (Upstash)</strong> - Delegaciones, cache, radio state</li>
      <li><strong>IPFS (Pinata)</strong> - Metadata, audio, imagenes</li>
    </ul>
  </div>
</div>

<div class="grid-2">
  <div class="box">
    <h3>Blockchain Layer</h3>
    <ul>
      <li><strong>Monad Mainnet</strong> - Chain ID 143, EVM compatible</li>
      <li><strong>Foundry (Forge)</strong> - Compilacion, deploy, verificacion</li>
      <li><strong>6 Smart Contracts</strong> - Todos verificados en MonadScan</li>
      <li><strong>Pyth Entropy</strong> - Randomness verificable on-chain</li>
    </ul>
  </div>
  <div class="box">
    <h3>Account Abstraction (ERC-4337)</h3>
    <ul>
      <li><strong>Pimlico Bundler</strong> - UserOp bundling + paymaster</li>
      <li><strong>Safe Smart Accounts</strong> - Platform Safe + User Safes</li>
      <li><strong>Delegaciones</strong> - 24h temporales, max 100 TX</li>
      <li><strong>Gas abstracto</strong> - Smart Account paga desde balance</li>
    </ul>
  </div>
</div>

<!-- Smart Contracts Detail -->
<h2>2. Smart Contracts</h2>

<table>
  <tr>
    <th>Contrato</th>
    <th>Address (Monad Mainnet)</th>
    <th>Funcionalidad</th>
    <th>Eventos Clave</th>
  </tr>
  <tr>
    <td><strong>EmpowerToursNFT</strong></td>
    <td class="mono" style="background:none;">0xB9B3...3B73F</td>
    <td>Music/Art NFTs, Licencias, Regalias, Burns</td>
    <td>MasterMinted, LicensePurchased, RoyaltyPaid, NFTBurned</td>
  </tr>
  <tr>
    <td><strong>PassportNFTV3</strong></td>
    <td class="mono" style="background:none;">0x9312...d5bd1851</td>
    <td>Pasaportes GPS, Stamps, Verificacion AI</td>
    <td>PassportMinted, VenueStampAdded, ItineraryStampAdded</td>
  </tr>
  <tr>
    <td><strong>ItineraryNFTV2</strong></td>
    <td class="mono" style="background:none;">0x9752...4b020</td>
    <td>Guias de Viaje, Purchases, Location Tracking</td>
    <td>ItineraryCreated, ItineraryPurchased, LocationCompleted</td>
  </tr>
  <tr>
    <td><strong>MusicSubscriptionV4</strong></td>
    <td class="mono" style="background:none;">0xCB11...45E5</td>
    <td>Suscripciones, Play Tracking, Payouts</td>
    <td>Subscribed, PlayRecorded, ArtistPayout, MonthlyDistribution</td>
  </tr>
  <tr>
    <td><strong>LiveRadioV2</strong></td>
    <td class="mono" style="background:none;">0x26b3...3101</td>
    <td>Jukebox, Queue, Tips, Rewards, Voice Notes</td>
    <td>SongQueued, SongPlayed, TipReceived, ListenerRewarded</td>
  </tr>
  <tr>
    <td><strong>PlayOracleV3</strong></td>
    <td class="mono" style="background:none;">0xe210...DCEf</td>
    <td>Backend Oracle para Play Recording</td>
    <td>PlayRecorded, OperatorAdded</td>
  </tr>
</table>

<!-- Data Flow -->
<h2>3. Flujo de Datos: Passport Mint</h2>

<div class="code-block">User (Warpcast) --> "mint my passport"
     |
     v
AI Oracle (Gemini) --> parse intent: type="mint_passport"
     |
     v
/api/oracle/chat --> calls /api/execute-delegated
     |
     v
execute-delegated:
  1. Validate contracts deployed
  2. Check WMON balance (150 WMON needed)
  3. Auto-wrap MON -> WMON if needed (separate UserOp)
  4. Approve WMON spending (separate UserOp)
  5. Call mintFor(beneficiary, fid, countryCode, ...)
     |
     v
PassportNFTV3.mintFor():
  - onlyAuthorizedMinter check
  - safeTransferFrom(msg.sender, platformWallet, 150 WMON)
  - _safeMint(beneficiary, tokenId)  <-- NFT goes to user's Farcaster wallet
  - emit PassportMinted(...)
     |
     v
Envio Indexer --> indexes PassportMinted event
     |
     v
/api/passport/image/[tokenId] --> generates dynamic SVG with stamps</div>

<!-- Account Abstraction Flow -->
<h2>4. Account Abstraction: Safe Architecture</h2>

<div class="grid-2">
  <div class="box">
    <h3>Platform Safe (Delegated Mode)</h3>
    <p>Cuando USE_USER_SAFES=false:</p>
    <ul>
      <li>Platform Safe paga gas y ejecuta TX</li>
      <li>NFTs se mintean al wallet del usuario</li>
      <li>Safe autorizado como minter en contratos</li>
      <li>Un Safe para todos los usuarios</li>
    </ul>
  </div>
  <div class="box">
    <h3>User Safes (Self-Funded Mode)</h3>
    <p>Cuando USE_USER_SAFES=true:</p>
    <ul>
      <li>Cada usuario tiene su propio Safe (deterministic)</li>
      <li>Usuario fondea su Safe con MON</li>
      <li>Platform Safe registra User Safe como minter</li>
      <li>User Safe ejecuta TX con sus propios fondos</li>
    </ul>
  </div>
</div>

<div class="code-block">User Safe Registration Flow:
1. getUserSafeAddress(userWallet) --> computes deterministic Safe address
2. ensureUserSafeRegistered() --> checks authorizedMinters mapping
3. If not registered:
   Platform Safe calls registerUserSafeAsMinter(userSafe)
   (Platform Safe is the platformOperator on contract)
4. User Safe can now call mintFor() directly</div>

<div class="page-break"></div>

<!-- AI Oracle Architecture -->
<h2>5. AI Oracle: Gemini Integration</h2>

<div class="box">
  <h3>Structured Output Schema</h3>
  <p>El Oracle usa Gemini 2.5 Flash con response schema forzado:</p>
  <div class="code-block">Action Types: navigate | execute | game | chat | create_nft |
              mint_passport | create_itinerary | sponsorship |
              admin | withdraw

Each action includes specific parameters:
- execute: { function, args, contract }
- mint_passport: { countryCode, countryName }
- withdraw: { token: "mon"|"wmon"|"tours", amount }
- sponsorship: { action, id, vote }
- admin: { action, tokenId, reason }</div>
</div>

<div class="grid-2">
  <div class="box">
    <h3>Google Maps Grounding</h3>
    <ul>
      <li>Activo cuando query tiene contexto geografico</li>
      <li>Incompatible con structured JSON output</li>
      <li>Retorna places con placeId, coords, ratings</li>
      <li>Costo: 2 MON por query (cobrado on-chain)</li>
      <li>Widget token para renderizar mapa</li>
    </ul>
  </div>
  <div class="box">
    <h3>AI Stamp Generation</h3>
    <ul>
      <li>Gemini 2.5 Flash Image genera PNG circular</li>
      <li>Estilo vintage unico por ubicacion</li>
      <li>Subido a IPFS via Pinata</li>
      <li>Renderizado dentro del Passport SVG</li>
      <li>Trigger: despues de addItineraryStamp TX</li>
    </ul>
  </div>
</div>

<!-- Live Radio Architecture -->
<h2>6. Live Radio: Sistema de Streaming On-Chain</h2>

<div class="flow-diagram">
  <div class="flow-box">Queue Song<br><span style="font-size:8px;">5 WMON</span></div>
  <div class="flow-arrow">&#8594;</div>
  <div class="flow-box">On-Chain TX<br><span style="font-size:8px;">SongQueued event</span></div>
  <div class="flow-arrow">&#8594;</div>
  <div class="flow-box">Scheduler<br><span style="font-size:8px;">Picks next song</span></div>
  <div class="flow-arrow">&#8594;</div>
  <div class="flow-box">SongPlayed<br><span style="font-size:8px;">Artist payout</span></div>
  <div class="flow-arrow">&#8594;</div>
  <div class="flow-box">Listeners<br><span style="font-size:8px;">TOURS rewards</span></div>
</div>

<div class="grid-2">
  <div class="box">
    <h3>Revenue Distribution</h3>
    <ul>
      <li>Queue fee (5 WMON): 70% artist, 20% platform, 10% treasury</li>
      <li>Tips: 100% directo al artista</li>
      <li>Voice notes (2 WMON): 50% platform, 50% speaker reward</li>
      <li>Random songs: Pyth Entropy seleccion verificable</li>
    </ul>
  </div>
  <div class="box">
    <h3>Listener Incentives</h3>
    <ul>
      <li>Heartbeat cada 30s verifica escucha activa</li>
      <li>TOURS rewards proporcionales a tiempo escuchado</li>
      <li>Streak bonus: 3, 7, 14, 30 dias consecutivos</li>
      <li>First listener bonus por dia</li>
      <li>Leaderboard semanal con rewards extra</li>
    </ul>
  </div>
</div>

<!-- Subscription Model -->
<h2>7. Music Subscription: Modelo 10/20/70</h2>

<div class="code-block">Monthly Revenue Distribution:
  Total Monthly Revenue (subscriptions collected)
       |
       ├── 10% --> Treasury (platform operations)
       ├── 20% --> Reserve Pool (gobernanza futura)
       └── 70% --> Artist Pool (distributed by play count)
                      |
                      └── Each artist receives:
                          (artist_plays / total_plays) * artist_pool
                          + TOURS bonus if eligible</div>

<!-- Security -->
<h2>8. Seguridad</h2>

<div class="grid-2">
  <div class="box">
    <h3>Smart Contract Security</h3>
    <ul>
      <li>OpenZeppelin: ReentrancyGuard, Ownable, Pausable</li>
      <li>SafeERC20 para todas las transferencias de tokens</li>
      <li>onlyAuthorizedMinter modifier para minteo delegado</li>
      <li>Timelock en operaciones DAO criticas</li>
      <li>Rate limiting: 24h cooldown entre mints</li>
      <li>Input validation: country codes, amounts, addresses</li>
    </ul>
  </div>
  <div class="box">
    <h3>Backend Security</h3>
    <ul>
      <li>Rate limiting por IP y wallet address</li>
      <li>Delegation system: permisos granulares, expiry 24h</li>
      <li>WMON approval limitada (mint price + 10%, no unlimited)</li>
      <li>Sanitizacion de inputs (XSS, injection prevention)</li>
      <li>Admin actions requieren signature + timestamp</li>
      <li>Anti-bot: community flagging + DAO vote</li>
    </ul>
  </div>
</div>

<!-- Indexing -->
<h2>9. Indexing: Envio HyperSync</h2>

<div class="box">
  <p>Envio indexa 30+ eventos de 6 contratos en tiempo real:</p>
  <div class="grid-3" style="margin-top: 8px;">
    <div>
      <h3>Music Events</h3>
      <ul>
        <li>MasterMinted</li>
        <li>CollectorMasterMinted</li>
        <li>LicensePurchased</li>
        <li>LicenseSold</li>
        <li>RoyaltyPaid</li>
        <li>PriceUpdated</li>
      </ul>
    </div>
    <div>
      <h3>Travel Events</h3>
      <ul>
        <li>PassportMinted</li>
        <li>VenueStampAdded</li>
        <li>ItineraryStampAdded</li>
        <li>ItineraryCreated</li>
        <li>ItineraryPurchased</li>
        <li>LocationCompleted</li>
      </ul>
    </div>
    <div>
      <h3>Radio/Sub Events</h3>
      <ul>
        <li>SongQueued / SongPlayed</li>
        <li>VoiceNoteSubmitted</li>
        <li>ListenerRewarded</li>
        <li>Subscribed / Renewed</li>
        <li>ArtistPayout</li>
        <li>MonthlyDistribution</li>
      </ul>
    </div>
  </div>
</div>

<!-- Deployment -->
<h2>10. Infraestructura de Deployment</h2>

<table>
  <tr><th>Servicio</th><th>Provider</th><th>Proposito</th></tr>
  <tr><td>Web App</td><td>Railway</td><td>Next.js production server</td></tr>
  <tr><td>Blockchain</td><td>Monad (rpc.monad.xyz)</td><td>Smart contract execution</td></tr>
  <tr><td>Bundler</td><td>Pimlico</td><td>ERC-4337 UserOp bundling</td></tr>
  <tr><td>Indexer</td><td>Envio (HyperSync)</td><td>Event indexing + GraphQL</td></tr>
  <tr><td>Cache</td><td>Upstash Redis</td><td>Delegations, radio state, sessions</td></tr>
  <tr><td>Storage</td><td>Pinata (IPFS)</td><td>NFT metadata, audio, images</td></tr>
  <tr><td>AI</td><td>Google Cloud (Gemini)</td><td>Oracle, Maps, Stamp generation</td></tr>
  <tr><td>Verification</td><td>MonadScan (Etherscan V2)</td><td>Contract source verification</td></tr>
</table>

<div style="margin-top: 20px; text-align: center; color: #475569; font-size: 9px;">
  EmpowerTours Technical Architecture v1.0 | Monad Mainnet | Chain ID: 143 | Enero 2025
</div>

</body>
</html>
