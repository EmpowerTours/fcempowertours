#!/usr/bin/env sh

echo "üîç Running pre-commit checks..."

# 1. Check for hardcoded secrets (actual values, not env var references)
echo "üîê Checking for exposed secrets..."
# Only flag actual hex private keys (0x + 64 hex chars not in a variable name context)
if git diff --cached | grep -E "^\+" | grep -v "process\.env" | grep -v "PRIVATE_KEY\s*=" | grep -E "0x[a-fA-F0-9]{64}" | grep -v ".env" > /dev/null 2>&1; then
  echo "‚ùå Hardcoded private key detected!"
  git diff --cached | grep -E "^\+" | grep -E "0x[a-fA-F0-9]{64}" | head -3
  exit 1
fi

# 1b. Block Claude as commit author (Co-Authored-By) - code using Anthropic SDK is allowed
# This only checks the commit message, not the code content
echo "ü§ñ Checking commit author..."
# Note: This check runs in prepare-commit-msg or commit-msg hook, not here
# Pre-commit runs before the message is written, so we skip this check here

# 2. TypeScript type check (only on staged .ts/.tsx files)
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | head -20 || true)
if [ -n "$STAGED_TS" ]; then
  echo "üìù Type checking TypeScript files..."
  if ! npx tsc --noEmit --skipLibCheck 2>&1 | head -30; then
    echo "‚ùå TypeScript errors found. Fix them before committing."
    exit 1
  fi
  echo "‚úÖ TypeScript check passed"
fi

# 3. Lint staged files (warning only)
STAGED_JS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)
if [ -n "$STAGED_JS" ]; then
  echo "üßπ Linting staged files..."
  echo "$STAGED_JS" | xargs npx eslint --max-warnings=0 2>&1 | head -50
  # Non-blocking - just warn
  echo "‚úÖ Lint check complete"
fi

# 4. Check for large files (>1MB)
echo "üì¶ Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only | while read file; do
  if [ -f "$file" ]; then
    size=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 1048576 ]; then
      echo "$file ($(($size / 1024))KB)"
    fi
  fi
done)
if [ -n "$LARGE_FILES" ]; then
  echo "‚ö†Ô∏è  Large files detected (>1MB):"
  echo "$LARGE_FILES"
  echo "   Consider using Git LFS or excluding these files."
fi

# 5. Prevent commits to main/master without PR (warning only)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo "‚ö†Ô∏è  Warning: Committing directly to $BRANCH branch"
fi

echo "‚úÖ Pre-commit checks complete!"
